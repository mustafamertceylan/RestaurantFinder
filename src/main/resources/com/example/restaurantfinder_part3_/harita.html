<!DOCTYPE html>
<html>
<head>
  <title>Veri ToplayÄ±cÄ± - TarayÄ±cÄ± Konumu</title>
  <meta charset="utf-8">
  <style>
    body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background: #f5f5f5;
    }
    #status {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        max-width: 600px;
        margin: 0 auto 20px auto;
    }
    .loading {
        text-align: center;
        color: #666;
    }
    .progress {
        background: #e0e0e0;
        height: 10px;
        border-radius: 5px;
        margin: 10px 0;
        overflow: hidden;
    }
    .progress-bar {
        background: #4CAF50;
        height: 100%;
        width: 0%;
        transition: width 0.3s ease;
    }
    #log {
        margin-top: 20px;
        padding: 10px;
        background: #f9f9f9;
        border-radius: 4px;
        max-height: 300px;
        overflow-y: auto;
        font-size: 12px;
    }
    .error { color: red; }
    .success { color: green; }
    .info { color: blue; }

    /* Harita stilleri */
    #mapContainer {
        display: none;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
        margin: 0 auto;
        max-width: 1000px;
    }

    #mapContainer.show {
        display: block;
    }

    #map {
        width: 100%;
        height: 500px;
    }

    #mapHeader {
        background: #2196F3;
        color: white;
        padding: 15px;
        text-align: center;
    }

    #mapStats {
        background: #f8f9fa;
        padding: 15px;
        display: flex;
        justify-content: space-around;
        text-align: center;
        border-top: 1px solid #e0e0e0;
    }

    .stat-item {
        flex: 1;
        padding: 0 10px;
    }

    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #2196F3;
    }

    .stat-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }

    /* Custom marker stilleri */
    .custom-marker {
        background: #4CAF50;
        border: 3px solid white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .user-marker {
        background: #FF5722;
        width: 25px;
        height: 25px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        body { padding: 10px; }
        #status { margin: 0 0 10px 0; }
        #map { height: 400px; }
        #mapStats {
            flex-direction: column;
            gap: 10px;
        }
    }
  </style>
</head>
<body>
<div id="status">
  <div class="loading">
    <h3>ğŸ“ Konum AlÄ±nÄ±yor...</h3>
    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <p id="statusText">Konum bilgisi alÄ±nÄ±yor...</p>
  </div>
  <div id="log"></div>
</div>

<!-- Harita Konteyneri -->
<div id="mapContainer">
  <div id="mapHeader">
    <h3>ğŸ—ºï¸ YakÄ±nÄ±mdaki Mekanlar</h3>
    <p id="locationInfo">Konum bilgisi yÃ¼kleniyor...</p>
  </div>
  <div id="map"></div>
  <div id="mapStats">
    <div class="stat-item">
      <div class="stat-number" id="cafeCount">0</div>
      <div class="stat-label">Kafe</div>
    </div>
    <div class="stat-item">
      <div class="stat-number" id="restaurantCount">0</div>
      <div class="stat-label">Restoran</div>
    </div>
    <div class="stat-item">
      <div class="stat-number" id="totalCount">0</div>
      <div class="stat-label">Toplam Mekan</div>
    </div>
    <div class="stat-item">
      <div class="stat-number" id="avgRating">0</div>
      <div class="stat-label">Ortalama Puan</div>
    </div>
  </div>
</div>

<script>
  console.log("ğŸš€ Sayfa yÃ¼klendi, baÄŸlantÄ±lar test ediliyor...");

  // WebSocket baÄŸlantÄ±sÄ±
  let socket;
  let socketConnected = false;

  function initWebSocket() {
    try {
      socket = new WebSocket('ws://localhost:8081');

      socket.onopen = function() {
        console.log("âœ… WebSocket baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±");
        addLog("âœ… WebSocket baÄŸlantÄ±sÄ± kuruldu", "success");
        socketConnected = true;

        // Test mesajÄ± gÃ¶nder
        testWebSocketConnection();
      };

      socket.onmessage = function(event) {
        console.log("ğŸ“¨ WebSocket mesajÄ± alÄ±ndÄ±:", event.data);
        addLog("ğŸ“¨ WebSocket mesajÄ±: " + event.data, "info");
      };

      socket.onclose = function() {
        console.log("âŒ WebSocket baÄŸlantÄ±sÄ± kapandÄ±");
        addLog("âŒ WebSocket baÄŸlantÄ±sÄ± kapandÄ±", "error");
        socketConnected = false;
      };

      socket.onerror = function(error) {
        console.error("âŒ WebSocket hatasÄ±:", error);
        addLog("âŒ WebSocket hatasÄ±: " + error, "error");
        socketConnected = false;
      };
    } catch (e) {
      console.error("âŒ WebSocket oluÅŸturma hatasÄ±:", e);
      addLog("âŒ WebSocket oluÅŸturma hatasÄ±: " + e.message, "error");
    }
  }

  function testWebSocketConnection() {
    const testData = {
      id: "test_" + Date.now(),
      name: "Test Mekan",
      type: "cafe",
      lat: 41.0082,
      lng: 28.9784,
      vicinity: "Test Adres",
      rating: 4.5,
      totalRatings: 100,
      photoUrl: "",
      openNow: true,
      distance: 500,
      duration: "5 mins"
    };

    if (socketConnected && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify(testData));
      console.log("ğŸ§ª Test verisi WebSocket ile gÃ¶nderildi:", testData);
      addLog("ğŸ§ª Test verisi gÃ¶nderildi: " + testData.name, "info");
    } else {
      console.error("âŒ WebSocket baÄŸlantÄ±sÄ± yok, test verisi gÃ¶nderilemedi");
      addLog("âŒ WebSocket baÄŸlantÄ±sÄ± yok", "error");
    }
  }

  function sendPlaceToJava(placeData) {
    console.log("ğŸ“¤ Java'ya gÃ¶nderiliyor:", placeData.name);

    // WebSocket ile gÃ¶nder
    if (socketConnected && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify(placeData));
      addLog("ğŸ“¤ GÃ¶nderildi: " + placeData.name, "success");
      return true;
    } else {
      console.error("âŒ WebSocket baÄŸlantÄ±sÄ± yok!");
      addLog("âŒ WebSocket baÄŸlantÄ±sÄ± yok: " + placeData.name, "error");
      return false;
    }
  }

  function updateStatus(message) {
      document.getElementById('statusText').textContent = message;
      addLog(message, "info");
  }

  function addLog(message, type = "info") {
      const log = document.getElementById('log');
      const time = new Date().toLocaleTimeString();
      const className = type || "info";
      log.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
      log.scrollTop = log.scrollHeight;
  }

  function updateProgress() {
      if (totalExpected > 0) {
          const progress = (placesProcessed / totalExpected) * 100;
          document.getElementById('progressBar').style.width = progress + '%';
      }
  }

  let map;
  let userLocation;
  let placesFound = 0;
  let placesProcessed = 0;
  let totalExpected = 0;
  let allPlaces = []; // TÃ¼m mekanlarÄ± saklayacak dizi
  const serviceTypes = ['cafe', 'restaurant'];

  function startDataCollection() {
      updateStatus("Konum alÄ±nÄ±yor...");
      addLog("ğŸ“ Geolocation API'si Ã§aÄŸrÄ±lÄ±yor...", "info");

      if (!navigator.geolocation) {
          addLog("âŒ Geolocation desteklenmiyor", "error");
          updateStatus("âŒ TarayÄ±cÄ±nÄ±z konum hizmetini desteklemiyor");
          return;
      }

      navigator.geolocation.getCurrentPosition(
          (position) => {
              userLocation = {
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
              };
              updateStatus(`âœ… Konum baÅŸarÄ±yla alÄ±ndÄ±: ${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`);
              addLog(`ğŸ“ Konum: ${userLocation.lat}, ${userLocation.lng}`, "success");

              initializeMap();
          },
          (error) => {
              updateStatus("âŒ Konum alÄ±namadÄ±: " + error.message);
              addLog(`âŒ Geolocation hatasÄ±: ${error.message}`, "error");

              // Test iÃ§in varsayÄ±lan konum kullan
              userLocation = { lat: 41.0082, lng: 28.9784 }; // Ä°stanbul
              addLog("ğŸ§ª Test iÃ§in varsayÄ±lan konum kullanÄ±lÄ±yor: Ä°stanbul", "info");
              initializeMap();
          },
          {
              enableHighAccuracy: true,
              timeout: 15000,
              maximumAge: 60000
          }
      );
  }

  function initializeMap() {
      if (!window.google || !window.google.maps) {
          addLog("âŒ Google Maps API yÃ¼klenmedi", "error");
          updateStatus("âŒ Google Maps API yÃ¼klenemedi");
          return;
      }

      try {
          // KÃ¼Ã§Ã¼k harita oluÅŸtur (veri toplama sÄ±rasÄ±nda gizli)
          map = new google.maps.Map(document.getElementById("map"), {
              zoom: 15,
              center: userLocation,
              mapTypeId: google.maps.MapTypeId.ROADMAP,
              styles: [
                {
                  featureType: "poi.business",
                  stylers: [{ visibility: "off" }]
                }
              ]
          });

          updateStatus("ğŸ—ºï¸ Harita hazÄ±r, mekan aramasÄ± baÅŸlatÄ±lÄ±yor...");
          addLog("ğŸ—ºï¸ Google Maps baÅŸarÄ±yla yÃ¼klendi", "success");

          setTimeout(searchPlaces, 1000);
      } catch (e) {
          addLog("âŒ Harita yÃ¼kleme hatasÄ±: " + e.message, "error");
          updateStatus("âŒ Harita yÃ¼klenemedi");
      }
  }

  function searchPlaces() {
      if (!map) {
          addLog("âŒ Harita hazÄ±r deÄŸil", "error");
          return;
      }

      let completedSearches = 0;
      addLog(`ğŸ” ${serviceTypes.length} farklÄ± mekan tÃ¼rÃ¼ aranacak`, "info");

      serviceTypes.forEach((type, index) => {
          addLog(`ğŸ” ${type.toUpperCase()} aranÄ±yor...`, "info");

          setTimeout(() => {
              const service = new google.maps.places.PlacesService(map);
              service.nearbySearch({
                  location: userLocation,
                  radius: 2000,
                  type: type
              }, (results, status) => {
                  completedSearches++;
                  addLog(`ğŸ“ ${type.toUpperCase()} sonucu: ${status}`, "info");

                  if (status === "OK" && results) {
                      const validPlaces = results.filter(place =>
                          place.business_status === "OPERATIONAL" &&
                          place.name && place.geometry?.location
                      );

                      totalExpected += validPlaces.length;
                      addLog(`âœ… ${type.toUpperCase()}: ${validPlaces.length} geÃ§erli sonuÃ§`, "success");

                      validPlaces.forEach((place, i) => {
                          setTimeout(() => processPlace(place, type), i * 300);
                      });
                  } else {
                      addLog(`âŒ ${type.toUpperCase()} aramasÄ± baÅŸarÄ±sÄ±z: ${status}`, "error");
                  }

                  if (completedSearches === serviceTypes.length) {
                      updateStatus(`ğŸ“‹ ${totalExpected} mekan iÅŸleniyor...`);
                      addLog(`ğŸ“Š Toplam ${totalExpected} mekan detaylarÄ± alÄ±nacak`, "info");
                  }
              });
          }, index * 1000);
      });
  }

  function processPlace(place, placeType) {
      const service = new google.maps.places.PlacesService(map);
      service.getDetails({
          placeId: place.place_id,
          fields: ['place_id', 'name', 'geometry', 'vicinity', 'rating', 'user_ratings_total', 'photos', 'opening_hours', 'business_status']
      }, (details, status) => {
          placesProcessed++;
          updateProgress();

          if (status === "OK" && details) {
              addLog(`ğŸª Detay alÄ±ndÄ±: ${details.name}`, "info");

              calculateDistance(details, (distance, duration) => {
                  const placeData = createPlaceData(details, placeType, distance, duration);
                  allPlaces.push(placeData); // MekanÄ± diziye ekle

                  const success = sendPlaceToJava(placeData);
                  if (success) {
                      placesFound++;
                  }
                  checkCompletion();
              });
          } else {
              addLog(`âŒ ${place.name} detaylarÄ± alÄ±namadÄ± (${status})`, "error");
              checkCompletion();
          }
      });
  }

  function calculateDistance(place, callback) {
      const directionsService = new google.maps.DirectionsService();
      directionsService.route({
          origin: userLocation,
          destination: place.geometry.location,
          travelMode: google.maps.TravelMode.DRIVING
      }, (response, status) => {
          if (status === "OK") {
              const leg = response.routes[0].legs[0];
              callback(leg.distance.value, leg.duration.text);
          } else {
              addLog(`âš ï¸ ${place.name} mesafe hesaplanamadÄ±`, "error");
              callback(null, null);
          }
      });
  }

  function createPlaceData(place, type, distance, duration) {
      return {
          id: place.place_id,
          name: place.name,
          type: type,
          lat: place.geometry.location.lat(),
          lng: place.geometry.location.lng(),
          vicinity: place.vicinity || "Bilinmiyor",
          rating: place.rating || 0,
          totalRatings: place.user_ratings_total || 0,
          photoUrl: (place.photos?.[0]) ? place.photos[0].getUrl({ maxWidth: 300 }) : "",
          openNow: place.opening_hours?.open_now || false,
          distance: distance,
          duration: duration
      };
  }

  function checkCompletion() {
      if (placesProcessed >= totalExpected && totalExpected > 0) {
          updateStatus(`ğŸ‰ TamamlandÄ±! ${placesFound} mekan Java'ya yÃ¼klendi`);
          addLog(`ğŸ“Š Ä°ÅŸlem tamamlandÄ±: ${placesFound}/${totalExpected} baÅŸarÄ±lÄ±`, "success");

          // HaritayÄ± gÃ¶ster ve gÃ¼ncelle
          setTimeout(() => {
              showFinalMap();

              if (window.notifyDataLoadComplete) {
                  window.notifyDataLoadComplete();
              }
          }, 500);
      }
  }

  function showFinalMap() {
      addLog("ğŸ—ºï¸ Harita hazÄ±rlanÄ±yor...", "info");

      // Harita konteynerini gÃ¶ster
      const mapContainer = document.getElementById('mapContainer');
      mapContainer.classList.add('show');

      // Konum bilgisini gÃ¼ncelle
      document.getElementById('locationInfo').textContent =
          `Enlem: ${userLocation.lat.toFixed(6)}, Boylam: ${userLocation.lng.toFixed(6)}`;

      // HaritayÄ± yeniden boyutlandÄ±r
      google.maps.event.trigger(map, 'resize');

      // KullanÄ±cÄ± konumu marker'Ä±
      new google.maps.Marker({
          position: userLocation,
          map: map,
          title: "Mevcut Konumunuz",
          icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 12,
              fillColor: '#FF5722',
              fillOpacity: 1,
              strokeColor: '#FFFFFF',
              strokeWeight: 3
          }
      });

      // Mekan marker'larÄ±nÄ± ekle
      let bounds = new google.maps.LatLngBounds();
      bounds.extend(userLocation);

      allPlaces.forEach(place => {
          const position = new google.maps.LatLng(place.lat, place.lng);

          const marker = new google.maps.Marker({
              position: position,
              map: map,
              title: place.name,
              icon: {
                  path: google.maps.SymbolPath.CIRCLE,
                  scale: 8,
                  fillColor: place.type === 'cafe' ? '#8BC34A' : '#FF9800',
                  fillOpacity: 1,
                  strokeColor: '#FFFFFF',
                  strokeWeight: 2
              }
          });

          // Info window
          const infoWindow = new google.maps.InfoWindow({
              content: `
                  <div style="padding: 10px; max-width: 200px;">
                      <h4 style="margin: 0 0 5px 0;">${place.name}</h4>
                      <p style="margin: 0; color: #666; font-size: 12px;">${place.vicinity}</p>
                      <div style="margin: 5px 0;">
                          <span style="background: ${place.type === 'cafe' ? '#8BC34A' : '#FF9800'};
                                       color: white; padding: 2px 6px; border-radius: 10px; font-size: 10px;">
                              ${place.type === 'cafe' ? 'â˜• Kafe' : 'ğŸ½ï¸ Restoran'}
                          </span>
                      </div>
                      ${place.rating > 0 ? `<div>â­ ${place.rating}/5 (${place.totalRatings} deÄŸerlendirme)</div>` : ''}
                      ${place.duration ? `<div>ğŸš— ${place.duration}</div>` : ''}
                      <div style="color: ${place.openNow ? 'green' : 'red'}; font-size: 12px;">
                          ${place.openNow ? 'ğŸŸ¢ AÃ§Ä±k' : 'ğŸ”´ KapalÄ±'}
                      </div>
                  </div>
              `
          });

          marker.addListener('click', () => {
              infoWindow.open(map, marker);
          });

          bounds.extend(position);
      });

      // Harita gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ ayarla
      map.fitBounds(bounds);
      map.setZoom(Math.min(map.getZoom(), 16));

      // Ä°statistikleri gÃ¼ncelle
      updateMapStats();

      addLog(`ğŸ—ºï¸ Harita ${allPlaces.length} mekan ile gÃ¼ncellendi`, "success");
  }

  function updateMapStats() {
      const cafeCount = allPlaces.filter(p => p.type === 'cafe').length;
      const restaurantCount = allPlaces.filter(p => p.type === 'restaurant').length;
      const totalCount = allPlaces.length;
      const avgRating = totalCount > 0 ?
          (allPlaces.reduce((sum, p) => sum + (p.rating || 0), 0) / totalCount).toFixed(1) : 0;

      document.getElementById('cafeCount').textContent = cafeCount;
      document.getElementById('restaurantCount').textContent = restaurantCount;
      document.getElementById('totalCount').textContent = totalCount;
      document.getElementById('avgRating').textContent = avgRating;
  }

  // Sayfa yÃ¼klendiÄŸinde baÅŸlat
  window.addEventListener('load', () => {
      addLog("ğŸš€ Sayfa yÃ¼klendi, baÄŸlantÄ±lar baÅŸlatÄ±lÄ±yor...", "info");

      // WebSocket baÄŸlantÄ±sÄ±nÄ± baÅŸlat
      initWebSocket();

      // Veri toplamayÄ± baÅŸlat
      setTimeout(startDataCollection, 2000);
  });

  // Test butonlarÄ± iÃ§in global fonksiyonlar
  window.testConnection = testWebSocketConnection;

  // Manuel test baÅŸlatma
  setTimeout(() => {
      console.log("ğŸ§ª 5 saniye sonra manuel test baÅŸlatÄ±lacak...");
      addLog("ğŸ§ª Manuel test 5 saniye sonra baÅŸlatÄ±lacak", "info");
  }, 5000);
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6WUm_MlnT4_M4tnfVnqTDd9f021ZInSo&libraries=places" async defer></script>
</body>
</html>