<!DOCTYPE html>
<html>
<head>
  <title>Yakƒ±ndaki Kafe ve Restoranlar</title>
  <meta charset="utf-8">
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }
    .gm-style .info-window {
        max-width: 300px !important;
        padding: 10px;
    }
    .place-image {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    .directions-btn {
        background: #4285F4;
        color: white;
        border: none;
        padding: 8px;
        margin-top: 10px;
        cursor: pointer;
        border-radius: 4px;
        width: 100%;
    }
    .distance-info {
        background: #f8f9fa;
        padding: 8px;
        border-radius: 4px;
        margin: 10px 0;
        font-size: 14px;
    }
    .place-type {
        color: #6c757d;
        font-size: 14px;
        margin: 5px 0;
    }
    .highlighted-marker {
        animation: bounce 1s infinite;
    }
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
<div id="map"></div>

<script>
  let map;
  let userLocation;
  let infoWindow;
  let directionsService;
  let allMarkers = new Map(); // T√ºm marker'larƒ± sakla
  let highlightedMarker = null;
  const serviceTypes = ['cafe', 'restaurant'];

  function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          mapTypeControl: false
      });

      infoWindow = new google.maps.InfoWindow();
      directionsService = new google.maps.DirectionsService();

      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
              position => {
                  userLocation = {
                      lat: position.coords.latitude,
                      lng: position.coords.longitude
                  };

                  map.setCenter(userLocation);

                  // Kullanƒ±cƒ± konum i≈üaret√ßisi
                  new google.maps.Marker({
                      position: userLocation,
                      map,
                      title: "Mevcut Konumunuz",
                      icon: {
                          path: google.maps.SymbolPath.CIRCLE,
                          scale: 8,
                          fillColor: "#4285F4",
                          fillOpacity: 1,
                          strokeWeight: 2,
                          strokeColor: "white"
                      }
                  });

                  // Mekanlarƒ± y√ºkle
                  loadPlaces();
              },
              error => {
                  handleLocationError(true);
              }
          );
      } else {
          handleLocationError(false);
      }
  }

  function loadPlaces() {
      console.log("Mekanlar y√ºkleniyor...");

      serviceTypes.forEach(type => {
          const service = new google.maps.places.PlacesService(map);
          service.nearbySearch(
              {
                  location: userLocation,
                  radius: 1000,
                  type: type,
                  openNow: true // Sadece a√ßƒ±k olanlar
              },
              (results, status) => {
                  if (status === "OK" && results) {
                      console.log(`${type} t√ºr√ºnde ${results.length} mekan bulundu`);
                      results.forEach(place => {
                          if (place.business_status === "OPERATIONAL") {
                              createMarker(place, type);
                              sendPlaceToJava(place, type);
                          }
                      });
                  }
              }
          );
      });
  }

  function createMarker(place, placeType) {
      if (!place.geometry?.location) return;

      const marker = new google.maps.Marker({
          map,
          position: place.geometry.location,
          title: place.name,
          icon: {
              url: `https://maps.google.com/mapfiles/ms/icons/${placeType === 'cafe' ? 'orange' : 'green'}-dot.png`
          }
      });

      // Marker'ƒ± Map'e kaydet
      allMarkers.set(place.place_id, marker);

      marker.addListener("click", () => {
          showPlaceDetails(place, marker);
      });
  }

  function sendPlaceToJava(place, placeType) {
      // Java'ya mekan bilgilerini g√∂nder
      if (window.javaController && window.sendPlaceToJava) {
          const placeData = {
              id: place.place_id,
              name: place.name || "ƒ∞simsiz Mekan",
              type: placeType,
              lat: place.geometry.location.lat(),
              lng: place.geometry.location.lng(),
              vicinity: place.vicinity || "Adres bilgisi yok",
              rating: place.rating || 0,
              totalRatings: place.user_ratings_total || 0,
              photoUrl: place.photos && place.photos[0] ?
                       place.photos[0].getUrl({ maxWidth: 300, maxHeight: 200 }) : "",
              openNow: place.opening_hours ? place.opening_hours.open_now : false
          };

          window.sendPlaceToJava(placeData);
          console.log("Java'ya g√∂nderildi:", place.name);
      }
  }

  async function showPlaceDetails(place, marker) {
      try {
          // Place Details API'den detaylarƒ± √ßek
          const service = new google.maps.places.PlacesService(map);
          service.getDetails({ placeId: place.place_id }, (placeDetails, status) => {
              if (status === "OK") {
                  const content = buildInfoWindowContent(placeDetails);
                  infoWindow.setContent(content);
                  infoWindow.open(map, marker);
                  calculateDistance(placeDetails.geometry.location, placeDetails.place_id);
              }
          });
      } catch (error) {
          console.error("Detaylar y√ºklenemedi:", error);
      }
  }

  function buildInfoWindowContent(place) {
      const type = place.types?.includes('cafe') ? 'Kafe' : 'Restoran';
      const photo = place.photos?.[0]?.getUrl({ maxWidth: 300, maxHeight: 200 }) || '';
      const rating = place.rating ? `‚≠ê ${place.rating}/5 (${place.user_ratings_total} deƒüerlendirme)` : 'Deƒüerlendirme yok';

      return `
          <div class="info-window">
              ${photo ? `<img class="place-image" src="${photo}" alt="${place.name}">` : ''}
              <h3 style="margin:10px 0">${place.name}</h3>
              <div class="place-type">${type}</div>
              <p>üìç ${place.vicinity}</p>
              <p>${rating}</p>
              <div class="distance-info" id="distance-info-${place.place_id}">
                  <span>‚è≥ Mesafe hesaplanƒ±yor...</span>
              </div>
              <button class="directions-btn"
                  onclick="window.open(
                      'https://www.google.com/maps/dir/?api=1&destination=${place.geometry.location.lat()},${place.geometry.location.lng()}',
                      '_blank'
                  )">üöó Yol Tarifi Al</button>
          </div>
      `;
  }

  function calculateDistance(destination, placeId) {
      directionsService.route(
          {
              origin: userLocation,
              destination: destination,
              travelMode: google.maps.TravelMode.DRIVING,
              unitSystem: google.maps.UnitSystem.METRIC
          },
          (response, status) => {
              const distanceElement = document.getElementById(`distance-info-${placeId}`);
              if (status === "OK") {
                  const distance = response.routes[0].legs[0].distance.text;
                  const duration = response.routes[0].legs[0].duration.text;

                  if (distanceElement) {
                      distanceElement.innerHTML = `
                          <div>üìè Mesafe: ${distance}</div>
                          <div>‚è±Ô∏è Tahmini S√ºre: ${duration}</div>
                      `;
                  }

                  // Java'ya mesafe bilgisini g√∂nder
                  if (window.javaController && window.updateDistanceInJava) {
                      window.updateDistanceInJava(placeId, distance, duration);
                  }
              } else {
                  if (distanceElement) {
                      distanceElement.innerHTML = "Mesafe bilgisi alƒ±namadƒ±";
                  }
              }
          }
      );
  }

  // Java'dan √ßaƒürƒ±lacak fonksiyon - Haritada mekanƒ± vurgula
  function highlightPlace(placeId, lat, lng) {
      // √ñnceki vurgulamasƒ± kaldƒ±r
      if (highlightedMarker) {
          highlightedMarker.setAnimation(null);
      }

      // Yeni mekanƒ± vurgula
      const marker = allMarkers.get(placeId);
      if (marker) {
          highlightedMarker = marker;
          marker.setAnimation(google.maps.Animation.BOUNCE);

          // Haritayƒ± merkeze getir
          map.panTo(new google.maps.LatLng(lat, lng));
          map.setZoom(17);

          // 3 saniye sonra animasyonu durdur
          setTimeout(() => {
              if (marker === highlightedMarker) {
                  marker.setAnimation(null);
              }
          }, 3000);
      }
  }

  function handleLocationError(browserHasGeolocation) {
      const content = browserHasGeolocation
          ? "Konum eri≈üimine izin vermeniz gerekiyor"
          : "Tarayƒ±cƒ±nƒ±z konum desteƒüi sunmuyor";

      infoWindow.setContent(content);
      infoWindow.open(map);
  }

  // Konsol loglarƒ± i√ßin global eri≈üim
  window.getAllMarkers = () => allMarkers;
  window.getUserLocation = () => userLocation;

  console.log("Harita scripti y√ºklendi");
</script>

<!-- API KEY'inizi buraya ekleyin -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6WUm_MlnT4_M4tnfVnqTDd9f021ZInSo&libraries=places&callback=initMap" async defer></script>
</body>
</html>